name: deploy
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: [self-hosted, runner-nginx]
    steps:
      - name: Setup Node
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          echo "$NVM_DIR/versions/node/$(node -v)/bin" >> $GITHUB_PATH

      - name: Checkout
        uses: actions/checkout@v6

      - name: Set env vars
        run: |
          echo "URL=athenaeum.no" >>$GITHUB_ENV
          echo "APP_NAME=athenaeum" >>$GITHUB_ENV
          echo "PORT=3002" >>$GITHUB_ENV

      - name: Deploy
        run: |
          TARGET_DIR="/home/zom/www/${{ env.URL }}"
          TEMP_DIR="/tmp/deploy-${{ env.URL }}-$$"
          CLONE_DIR="$TEMP_DIR/repo_clone"

          git clone "git@github.com:${{ github.repository }}.git" "$CLONE_DIR"
          mkdir -p "$TARGET_DIR"
          rsync -av --delete \
            --exclude='.env' \
            --exclude='logs' \
            --exclude='public/uploads' \
            "$CLONE_DIR/" "$TARGET_DIR/"

          cd "$TARGET_DIR"
          npm ci || npm install
          MAIN_FILE=$(node -e "console.log(require('./package.json').main || 'server.js')" 2>/dev/null || echo "server.js")
          [[ -f "$MAIN_FILE" ]] && node -c "$MAIN_FILE"
          pm2 describe ${{ env.APP_NAME }} > /dev/null 2>&1
          [[ $? -eq 0 ]] && pm2 reload ${{ env.APP_NAME }} --update-env || pm2 start ${{ env.APP_NAME }}
          rm -rf "$TEMP_DIR" "$CLONE_DIR"

      - name: Verify
        run: |
          sleep 5
          pm2 describe ${{ env.APP_NAME }} | grep "status" | grep -q "online" || exit 1
          curl -sf http://localhost:${{ env.PORT }}/health || exit 1